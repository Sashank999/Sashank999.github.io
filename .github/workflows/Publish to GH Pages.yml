name: Publish to GH Pages

on:
  push:
    branches: ["master"]

  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "Pages"
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest

    # https://stackoverflow.com/a/75662195
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: "true"
      - name: Setup Node.js environment
        uses: actions/setup-node@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.2.0
        with:
          version: latest

      - name: Setup pages
        uses: actions/configure-pages@v5

      - name: Create a website root folder
        run: |
          mkdir website-root

      - name: Build static-qr-gen
        run: |
          cd static-qr-gen
          npm install
          npx -p @angular/cli ng build --base-href /static-qr-gen/
          cd dist
          cd static-qr-gen
          mv browser static-qr-gen
          mv static-qr-gen ../../../website-root
          cd ..
          cd ..
          cd ..

      - name: Build static-qr-gen-react
        run: |
          cd static-qr-gen-react
          pnpm install

          echo '/** @type {import('next').NextConfig} */' > next.config.mjs
          echo 'const nextConfig = {'                     >> next.config.mjs
          echo '  output: "export",'                      >> next.config.mjs
          echo '  basePath: "/static-qr-gen-react"'       >> next.config.mjs
          echo '};'                                       >> next.config.mjs
          echo 'export default nextConfig;'               >> next.config.mjs

          pnpm run build
          mv out static-qr-gen-react
          mv static-qr-gen-react ../website-root
          cd ..

      - name: Move the spacex-clone repo
        run: |
          mv spacex-clone website-root

      - name: Create quotes database for portfolio website
        run: |
          wget -q 'https://raw.githubusercontent.com/dwyl/quotes/45bdefe4e8b291a26c7b4c4a8dd1e24139ab7a17/quotes.json'
          jq '.[] | [.author, .text] | join(";")' -c -r < quotes.json > quotes.txt
          shuf -o website-root/randomised_quotes.txt quotes.txt
          node portfolio_quotes_processor.js website-root/randomised_quotes.txt website-root/quotes_indices.txt
          rm quotes.json quotes.txt

      - name: Move portfolio repo (as the actual website, hiding the repos)
        run: |
          mv portfolio/* website-root

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "website-root"

      - name: Deploy to Github Pages
        id: deployment
        uses: actions/deploy-pages@v4
